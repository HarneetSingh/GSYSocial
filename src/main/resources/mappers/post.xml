<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.motionapps.GSYSocial.dao.PostDao">

    <resultMap id="postMap" type="Post" >
        <id column="post_id" property="postId"  />
      	<result column="joint_account_id" property="jointAccountId" />
        <result column="file_url" property="fileUrl" />
        <result column="file_type" property="fileType"/>
        <result column="post_text" property="postText" />
        <result column="total_rating" property="totalRating" />
        <result column="no_of_ratings" property="noOfRatings" />
 		<result column="created_time" property="createdTime" />
 		<result column="last_updated_time" property="lastUpdatedTime" />
 		<result column="user_name" property="userName"/>
        <result column="profile_pic" property="profilePicUrl" />
        <result column="thumb_nail_url" property="thumbNameUrl" /> 		
        <result column="comment_count" property="commentCount" /> 		
        
	</resultMap>   
 
    
 	<!-- ************** CREATE ************** -->
 	<insert id="createPost" parameterType="Post" useGeneratedKeys="true">
		INSERT 
			INTO post
		SET 
			post_id = #{postId},
			joint_account_id = #{jointAccountId},
			file_url = #{fileUrl},
			file_type = #{fileType},
			post_text = #{postText},
			user_name = #{userName},
			profile_pic = #{profilePicUrl},
			thumb_nail_url= #{thumbNameUrl},
			last_updated_time=now(),
			created_time=now();
 	</insert>   
	
    <!-- ************** READ ************** -->
    <select id="getPostByJointAccount" parameterType="String" resultMap="postMap">
        SELECT
			post_id,
			joint_account_id,
			file_url,
			file_type,
			thumb_nail_url,
			post_text,
			user_name,
			profile_pic,
			comment_count,
			total_rating,
			no_of_ratings,
			created_time,
			last_updated_time
        FROM
            post
		WHERE      
        	joint_account_id=#{value}
        ORDER BY
        	created_time desc; 	            	
    </select>
    
        <select id="getPostById" parameterType="String" resultMap="postMap">
        SELECT
			post_id,
			joint_account_id,
			file_url,
			file_type,
			thumb_nail_url,
			post_text,
			user_name,
			profile_pic,
			comment_count,
			total_rating,
			no_of_ratings,
			created_time,
			last_updated_time
        FROM
            post
		WHERE      
        	post_id=#{value}          	
    </select>
    
    <select id="getPostForUser" parameterType="String" resultMap="postMap">
        SELECT
			post.post_id,
			post.joint_account_id,
			post.file_url,
			post.file_type,
			post.thumb_nail_url,
			post.post_text,
			post.user_name,
			post.profile_pic,
			post.comment_count,
			post.total_rating,
			post.no_of_ratings,
			post.created_time,
			post.last_updated_time
        FROM
            post
         INNER JOIN
        	follower
        ON
        	post.joint_account_id=follower.joint_account_id	
        AND
        	follower.user_id=#{value}
        ORDER BY
        	post.created_time desc; 	            	
    </select>
    
    <select id="getAllPosts" parameterType="String" resultMap="postMap">
        SELECT
			post_id,
			joint_account_id,
			file_url,
			file_type,
			thumb_nail_url,	
			post_text,
			user_name,
			profile_pic,
			comment_count,
			total_rating,
			no_of_ratings,
			created_time,
			last_updated_time
        FROM
            post; 	            	
    </select>
	     	
 	<!-- ************** UPDATE ************** -->
 
 	<update id="updatePost" parameterType="Post">
		UPDATE 
			post
		SET 
			post_id = #{postId}
			<if test="fileUrl != null">
				,file_url = #{fileUrl}
				,last_updated_time=now()				
			</if>
			<if test="fileType != null">
				,file_type = #{fileType}
			    ,last_updated_time=now()
			</if>
			<if test="postText != null">
				,post_text = #{postText}
				,last_updated_time=now()
			</if>
			<if test="profilePicUrl != null">
				,profile_pic = #{profilePicUrl}
				,last_updated_time=now()
			</if>
			<if test="thumbNameUrl != null">
				,thumb_nail_url = #{thumbNameUrl}
				,last_updated_time=now()
			</if>
		WHERE
			post_id = #{postId}
 	</update>  
 	
 	<update id="addRatings" parameterType="Post">
 	    UPDATE 
			post
		SET 
			post_id = #{postId}
			<if test="rating != null">
				,total_rating=totalRating+#{rating},
				,no_of_ratings=no_of_ratings+1,
				,last_updated_time=now()				
			</if>
		WHERE
			post_id = #{postId}
 	</update>
 	
 	<update id="incrementCommentCount" parameterType="String">
 	    UPDATE
 	    	post
 	    SET
 	    	comment_count = comment_count + 1
 	    WHERE
 	    	post_id=#{value}	
 	</update>
 	
 	<update id="decrementCommentCount" parameterType="String">
 	    UPDATE
 	    	post
 	    SET
 	    	comment_count = comment_count - 1
 	    WHERE
 	    	post_id=#{value}	
 	</update>
 	
 		<!-- ************** DELETE ************** -->
 	
 	    <delete id="deletePost" parameterType="String">
		DELETE FROM post WHERE post_id = #{value}
	</delete>
			
 	
</mapper>